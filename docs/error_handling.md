# エラーハンドリング

Grimoireは包括的なエラーハンドリングシステムを提供し、デバッグを容易にします。

## エラーコード

各エラータイプには一意のエラーコードが割り当てられています：

### ファイルエラー (E1000番台)
- `E1001`: ファイルが見つかりません
- `E1002`: サポートされていない形式
- `E1003`: ファイル読み込みエラー
- `E1004`: ファイル書き込みエラー

### 検出エラー (E2000番台)
- `E2001`: シンボルが検出されません
- `E2002`: 外周円が検出されません
- `E2003`: 無効なシンボル形状
- `E2004`: 画像処理エラー

### パーサーエラー (E3000番台)
- `E3001`: 構文エラー
- `E3002`: 予期しないシンボル
- `E3003`: メインエントリーポイントが見つかりません
- `E3004`: 無効な接続
- `E3005`: 式のバランスが取れていません

### コンパイラエラー (E4000番台)
- `E4001`: コンパイルエラー
- `E4002`: サポートされていない操作

### 実行時エラー (E5000番台)
- `E5001`: 実行エラー

### 検証エラー (E6000番台)
- `E6001`: 検証エラー

### I/Oエラー (E7000番台)
- `E7001`: I/Oエラー

## エラーメッセージの構造

エラーメッセージは以下の情報を含みます：

1. **エラーコード**: プログラム的な処理のための一意の識別子
2. **エラータイプ**: エラーのカテゴリ（ローカライズ済み）
3. **メッセージ**: エラーの簡潔な説明
4. **位置情報**: ファイル名、行番号、列番号（該当する場合）
5. **詳細**: エラーの詳細な説明
6. **提案**: 問題を解決するための具体的な提案
7. **原因**: 内部エラー（該当する場合）

### 例：通常モード

```
[E3003] [メインエントリーポイントが見つかりません] Main entry point not found
  詳細: 二重円（DoubleCircle）シンボルが画像内で検出されませんでした
  提案: 魔法陣の上部にダブルサークル（◎）シンボルを追加してメインエントリーポイントを定義してください
```

## デバッグモード

デバッグモードを有効にすると、追加の情報が表示されます：

- コンテキスト情報（操作、ステージなど）
- スタックトレース
- 詳細なメタデータ

### デバッグモードの有効化

1. **コマンドラインフラグ**:
   ```bash
   grimoire compile magic_circle.png --debug
   ```

2. **環境変数**:
   ```bash
   export GRIMOIRE_DEBUG=1
   grimoire compile magic_circle.png
   ```

### 例：デバッグモード

```
[E3005] [式のバランスが取れていません] Binary operator equal requires two operands, found 1
  場所: magic_circle.png:311:543
  詳細: At position (311, 543)
  提案: Ensure the operator is connected to two operand symbols
Context:
  operand_count: 1
  symbol_type: equal
  operation: parse
  stage: expression_parsing
Stack Trace:
  1. github.com/ayutaz/grimoire/internal/parser.(*Parser).parseExpression
     /path/to/parser.go:245
  2. github.com/ayutaz/grimoire/internal/parser.(*Parser).Parse
     /path/to/parser.go:125
  3. main.processImage
     /path/to/main.go:89
```

## よくあるエラーと対処法

### 1. メインエントリーポイントが見つかりません (E3003)

**原因**: 魔法陣にダブルサークル（◎）シンボルがない

**解決方法**:
- 魔法陣の上部にダブルサークルを追加
- 二重の円を明確に描く（外側と内側の円）

### 2. 外周円が検出されません (E2002)

**原因**: 魔法陣を囲む円が検出されない

**解決方法**:
- 円が完全に閉じていることを確認
- 円の線を太く、明確に描く
- 背景とのコントラストを高める

### 3. 式のバランスが取れていません (E3005)

**原因**: 演算子に必要な数のオペランドが接続されていない

**解決方法**:
- 二項演算子には2つのオペランドを接続
- 接続線が明確に描かれていることを確認

## エラーの国際化

エラーメッセージは日本語と英語に対応しています：

- 日本語: `GRIMOIRE_LANG=ja` または `--lang ja`
- 英語: `GRIMOIRE_LANG=en` または `--lang en`

システムのロケール設定も自動的に検出されます。