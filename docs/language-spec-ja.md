# Grimoire言語仕様 v1.0

## 目次
1. [はじめに](#introduction)
2. [基本図形とその意味](#basic-shapes)
3. [シンボルと演算子](#symbols-operators)
4. [プログラム構造](#program-structure)
5. [データ型](#data-types)
6. [制御フロー](#control-flow)
7. [関数とスコープ](#functions-scope)
8. [エラー処理](#error-handling)
9. [高度な機能](#advanced-features)

## はじめに {#introduction}

Grimoireは、手描きの魔法陣としてプログラムを表現するビジュアルプログラミング言語です。各幾何学図形、シンボル、およびそれらの空間的関係が意味を持ちます。

### 基本原則
- **空間的プログラミング**: 位置と接続が実行フローを決定
- **図形の意味論**: 各図形には固有の意味がある
- **シンボルの密度**: 複雑な操作をコンパクトなシンボルで表現
- **芸術的自由**: 同じプログラムを描く複数の有効な方法

## 基本図形とその意味 {#basic-shapes}

### 主要図形

| 図形 | シンボル | 意味 | 使用方法 |
|------|----------|------|----------|
| 円 | ○ | スコープ/関数 | 境界と関数空間を定義 |
| 四角 | □ | データ/変数 | 値と状態を格納 |
| 三角 | △ | 判定/分岐 | 条件付き実行 |
| 五角形 | ⬟ | ループ/反復 | 繰り返し実行 |
| 六角形 | ⬢ | 並列/非同期 | 並行実行 |
| 星(5点) | ☆ | 入出力 | I/O操作 |
| 星(6点) | ✡ | ネットワーク/外部 | 外部接続 |

### 図形の修飾子

- **中心点 vs 空白**: 中心に点(•)は定数、空白は変数
- **二重境界線**: 保護/不変
- **破線境界**: オプショナル/Nullable
- **波線境界**: 遅延評価
- **点線境界**: 弱い参照/ウィークポインタ
- **太線**: 重要/最適化対象
- **細線**: 低優先度/コールドパス

### 線による型表現

変数の型は図形内の記号で表現：
- **#**: 整数型 (例: `□ #x = 42`)
- **~**: 浮動小数点型 (例: `□ ~pi = 3.14`)
- **$**: 文字列型 (例: `□ $name = "Alice"`)
- **?**: ブール型 (例: `□ ?flag = true`)
- **@**: 参照型 (例: `□ @ptr`)
- **[]: 配列型 (例: `□ []numbers`)
- **{}: マップ型 (例: `□ {}dict`)

## シンボルと演算子 {#symbols-operators}

### 算術演算子
```
+ : 加算（十字）
- : 減算（横線）
× : 乗算（X字）
÷ : 除算（点付き横線）
% : 剰余（パーセント記号）
^ : 累乗（上向き矢印）
```

### 論理演算子
```
∧ : AND（上向きくさび）
∨ : OR（下向きくさび）
¬ : NOT（フック記号）
⊕ : XOR（丸付きプラス）
→ : 含意（矢印）
```

### 比較演算子
```
= : 等しい（平行線）
≠ : 等しくない（交差した等号）
< : より小さい
> : より大きい
≤ : 以下
≥ : 以上
```

### 特殊シンボル
```
∞ : 無限/無限ループ
∅ : ヌル/無効
π : 円周率定数
λ : ラムダ/無名関数
Σ : 総和/リデュース
∫ : 積分/マップ
```

## プログラム構造 {#program-structure}

### エントリーポイント
すべてのGrimoireプログラムには、二重境界線または記号`◎`でマークされたメイン円が必要です。

```
◎ ← メインエントリーポイント
|
○ ← 関数定義
|
□ ← グローバル変数
```

### 実行フロー
1. プログラムは最外側のメイン円から実行
2. フローはデフォルトで時計回りに接続線をたどる
3. 反時計回りのフローはコールバックまたはリターンを示す
4. 交差した線は並列実行パスを示す

### 例: 基本的なプログラム構造
```
        ◎ (メイン)
       / | \
      /  |  \
     □   △   ○
  (データ)(条件)(関数)
```

## データ型 {#data-types}

### プリミティブ型
図形の色やパターンで示される：
- **整数**: 黒い実線の輪郭
- **浮動小数点**: グレー/グラデーション輪郭
- **文字列**: 引用符付きテキストまたは波線輪郭
- **ブール値**: 中心に点（•）でtrue、空でfalse
- **ルーン**: 三角形内の単一文字

### 複合型
- **配列**: 接続された四角 `□-□-□`
- **マップ/辞書**: 内部分割された六角形
- **セット**: 内部に点がある円
- **タプル**: 括弧内のグループ化された図形

### 型推論
コンパイラは以下から型を推論：
1. 図形パターン
2. 接続された演算子
3. 初期値
4. 使用コンテキスト

## 制御フロー {#control-flow}

### 条件実行（三角形）
```
    △
   / \
  /   \
 ○     ○
(真) (偽)
```

### ループ（五角形）
```
⬟ (5) ← 5回ループ
|
○ ← ループ本体

⬟ (∞) ← 無限ループ
|
○
```

### パターンマッチング（入れ子の三角形）
```
    △
   /|\
  / | \
 △  △  △
(パターン)
```

## 関数とスコープ {#functions-scope}

### 関数定義
```
○ 関数名(パラメータ)
├─ □ (ローカル変数)
├─ ⬟ (ロジック)
└─ ☆ (戻り値)
```

### スコープルール
1. 内側の円は外側の円の変数にアクセス可能
2. 重なる円はスコープを共有
3. 点線の円境界はクロージャキャプチャを示す

### 無名関数（ラムダ）
```
λ○ ← ラムダ円
|
式
```

## エラー処理 {#error-handling}

### Try-Catchパターン
```
○ (try)
├─ ~~~~ (波線 = 失敗する可能性)
└─ ○! (！付きcatch円)
```

### エラータイプ
- **!**: 一般的なエラー
- **!!**: 致命的エラー
- **?**: 警告
- **...**: タイムアウト

## 高度な機能 {#advanced-features}

### メタプログラミング
引用符付き円内に図形を描くとコード生成コードを作成：
```
"○" ← 引用符付き円は円を生成
```

### 並行性パターン
```
   ⬢ (6スレッド生成)
  /|\
 / | \
○  ○  ○ (並列タスク)
 \ | /
  \|/
   ⬢ (結合)
```

### メモリ管理
- **実線矢印**: 強い参照
- **破線矢印**: 弱い参照
- **点線矢印**: 遅延参照
- **⊗**: 明示的な解放

### 最適化ヒント
線の太さは最適化優先度を示す：
- 細い: コールドパス
- 通常: 通常パス
- 太い: ホットパス（積極的に最適化）

### デバッグ注釈
- **👁**: ウォッチポイント
- **🐛**: ブレークポイント
- **📍**: アサーション
- **💭**: コメントバブル

## シンボル結合ルール

1. **隣接**: 隣接するシンボルは操作を結合
2. **入れ子**: 内側のシンボルは外側のシンボルを修飾
3. **重複**: 共有プロパティ
4. **距離**: 遠いシンボルは結合が弱い

## ファイル形式

Grimoireファイルは`.grim`拡張子を使用し、以下の形式が可能：
1. **PNG/JPG**: スキャンまたはデジタル描画
2. **SVG**: 正確な図形のためのベクター形式
3. **GRIM**: バイナリコンパイル形式

## コンパイル指示

画像の隅の特殊シンボル：
- **左上**: バージョン番号
- **右上**: 最適化レベル
- **左下**: ターゲットプラットフォーム
- **右下**: デバッグ情報

---

*この仕様は言語の進化に伴い変更される可能性があります。*