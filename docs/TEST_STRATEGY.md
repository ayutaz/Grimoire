# Grimoireテスト戦略

t-wadaさんのTDDアプローチに基づいたテスト戦略。

## TDDの原則

### 1. Red-Green-Refactor サイクル
1. **Red**: 失敗するテストを書く
2. **Green**: テストを通す最小限のコードを書く
3. **Refactor**: コードを改善する

### 2. テストの三原則
- **自動化されている**: CIで自動実行
- **独立している**: 他のテストに依存しない
- **繰り返し可能**: 何度でも同じ結果

### 3. AAA パターン
- **Arrange**: 事前準備
- **Act**: 実行
- **Assert**: 検証

## テストピラミッド

```
       /\
      /  \  E2E Tests (10%)
     /----\
    /      \  Integration Tests (30%)
   /--------\
  /          \  Unit Tests (60%)
 /____________\
```

## テスト項目

### Unit Tests（単体テスト）

#### 1. 画像認識モジュール (`test_image_recognition.py`)
- [ ] シンボル検出
  - [ ] 外円の検出（必須要件）
  - [ ] 基本図形の検出（円、四角、三角、五角形、六角形、星）
  - [ ] 演算子シンボルの検出（収束、発散、増幅、分配）
  - [ ] 二重円の検出
  - [ ] シンボル内パターンの認識（ドット、線、半円）
- [ ] 接続検出
  - [ ] 直線接続の検出
  - [ ] 曲線接続の検出
  - [ ] 矢印の方向検出
- [ ] エッジケース
  - [ ] 小さすぎるシンボル
  - [ ] 重なり合うシンボル
  - [ ] ノイズの多い画像
  - [ ] 手書きの不完全な図形

#### 2. パーサー (`test_parser.py`)
- [ ] AST構築
  - [ ] プログラム構造の解析
  - [ ] 関数定義の解析
  - [ ] ステートメントの解析
  - [ ] 式の解析
- [ ] シンボルからASTへの変換
  - [ ] 数値リテラル（ドットパターン）
  - [ ] 演算子の変換
  - [ ] 制御構造（if、while、for）
  - [ ] 並列実行ブロック
- [ ] 接続推論
  - [ ] 明示的接続がない場合の推論
  - [ ] 空間的配置による推論
  - [ ] データフロー解析
- [ ] エラー処理
  - [ ] 外円なしエラー
  - [ ] 無効な構文エラー
  - [ ] 未定義シンボルエラー

#### 3. インタープリター (`test_interpreter.py`)
- [ ] 基本実行
  - [ ] リテラル評価
  - [ ] 変数定義と参照
  - [ ] 算術演算（加減乗除）
  - [ ] 比較演算
  - [ ] 論理演算
- [ ] 制御フロー
  - [ ] if文
  - [ ] while文
  - [ ] for文（ループ）
  - [ ] 関数呼び出し
  - [ ] 再帰
- [ ] 並列実行
  - [ ] 並列ブロックの実行
  - [ ] スレッド管理
  - [ ] 結果の集約
- [ ] エラー処理
  - [ ] ゼロ除算
  - [ ] 未定義変数
  - [ ] 型エラー
  - [ ] スタックオーバーフロー

#### 4. コード生成器 (`test_code_generator.py`)
- [ ] Python生成
  - [ ] 基本構造（import、main関数）
  - [ ] 変数宣言
  - [ ] 式の生成
  - [ ] 制御構造の生成
  - [ ] 関数定義の生成
  - [ ] 並列実行コードの生成
- [ ] コード品質
  - [ ] インデント
  - [ ] 変数名の一意性
  - [ ] エスケープ処理
  - [ ] コメント生成

### Integration Tests（統合テスト）

#### 1. コンパイラ統合 (`test_compiler.py`)
- [ ] エンドツーエンド
  - [ ] 最小プログラム（外円のみ）
  - [ ] Hello World
  - [ ] 算術演算（1+2）
  - [ ] 条件分岐
  - [ ] ループ
  - [ ] 関数定義と呼び出し
  - [ ] 並列実行
- [ ] エラーパス
  - [ ] 画像読み込みエラー
  - [ ] 構文エラー
  - [ ] 実行時エラー
- [ ] 出力形式
  - [ ] インタープリター実行
  - [ ] Pythonコード生成
  - [ ] デバッグ情報

#### 2. CLI統合 (`test_cli.py`)
- [ ] コマンド実行
  - [ ] compile コマンド
  - [ ] run コマンド
  - [ ] debug コマンド
- [ ] オプション
  - [ ] --output
  - [ ] --mode (traditional/ai/hybrid)
- [ ] エラー処理
  - [ ] 無効な引数
  - [ ] ファイルが見つからない

### E2E Tests（エンドツーエンドテスト）

#### 1. 実際の手書き画像 (`test_e2e.py`)
- [ ] サンプルプログラム
  - [ ] FizzBuzz
  - [ ] フィボナッチ数列
  - [ ] 素数判定
  - [ ] ソート
- [ ] 複雑な制御フロー
  - [ ] ネストしたループ
  - [ ] 複数の関数
  - [ ] 再帰関数

## テストのベストプラクティス

### 1. テストの命名規則
```python
def test_対象_状況_期待結果():
    """
    例: test_parse_without_outer_circle_raises_error
    """
```

### 2. テストの構造
```python
def test_example():
    # Arrange
    input_data = create_test_data()
    expected = "expected result"
    
    # Act
    result = function_under_test(input_data)
    
    # Assert
    assert result == expected
```

### 3. テストダブル
- Mock: 外部依存の置き換え
- Stub: 固定値を返す
- Spy: 呼び出しを記録

### 4. プロパティベーステスト
```python
@given(st.integers())
def test_property(value):
    # 任意の整数で成立する性質をテスト
    pass
```

## カバレッジ目標

- 全体: 80%以上
- クリティカルパス: 95%以上
- エラーハンドリング: 90%以上

## 継続的改善

1. テスト実行時間の監視
2. フレイキーテストの削減
3. テストの保守性向上
4. 新機能追加時のテストファースト